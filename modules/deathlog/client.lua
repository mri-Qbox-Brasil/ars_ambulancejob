local Config = lib.load("config")
local weapons = lib.load("data.weapons")
local bodyParts = lib.load("data.body_parts")

local Weapon_Groups = {
    [2685387236] = 'Melee',
    [-1609580060] = 'Melee',
    [4257178988] = 'Melee',
    [-37788308] = 'Melee',
    [3566412244] = 'Melee',
    [-728555052] = 'Melee',
    [416676503] = 'Pistol',
    [970310034] = 'Assault Rifle',
    [860033945] = 'Shotgun',
    [1159398588] = 'LMG',
    [3337201093] = 'SMG',
    [-957766203] = 'SMG',
    [3082541095] = 'Sniper',
    [-1212426201] = 'Sniper',
    [2725924767] = 'Heavy',
    [-1569042529] = 'Heavy',
    [690389602] = 'Stunned',
    [1548507267] = 'Throwable',
}

local function getWeaponData(weaponHash)
    if weapons[weaponHash] then
        return weapons[weaponHash]
    end

    for key, value in pairs(weapons) do
        if type(key) == "string" then
            local hash = GetHashKey(key)
            if hash == weaponHash then
                return value, key
            end
        end
    end

    return nil, nil
end

local function processPlayerDeath()
    local playerPed = cache.ped or PlayerPedId()
    local causeOfDeath = GetPedCauseOfDeath(playerPed)
    local sourceOfDeath = GetPedSourceOfDeath(playerPed)
    local coords = GetEntityCoords(playerPed)
    local streetName = GetStreetNameFromHashKey(GetStreetNameAtCoord(coords.x, coords.y, coords.z))

    local killerServerId
    local vehicleName
    local isVehicleKill = false

    if sourceOfDeath ~= 0 then
        if IsEntityAVehicle(sourceOfDeath) then
            local driver = GetPedInVehicleSeat(sourceOfDeath, -1)
            if driver ~= 0 then
                if IsPedAPlayer(driver) then
                    local veh = GetVehiclePedIsIn(driver, false)
                    local modelHash = GetEntityModel(veh)
                    local modelName = GetDisplayNameFromVehicleModel(modelHash)
                    vehicleName = GetLabelText(modelName)

                    if vehicleName == "NULL" then
                        vehicleName = modelName
                    end

                    killerServerId = GetPlayerServerId(NetworkGetPlayerIndexFromPed(driver))
                end
                isVehicleKill = true
            end
        elseif IsEntityAPed(sourceOfDeath) and IsPedAPlayer(sourceOfDeath) then
            killerServerId = GetPlayerServerId(NetworkGetPlayerIndexFromPed(sourceOfDeath))
        end
    end

    local weaponName = locale("deathlog_unknown")
    local deathReasonShort = locale("deathlog_killed")
    local deathReason = locale("deathlog_was_killed")

    local weaponData, weaponKey = getWeaponData(causeOfDeath)

    if weaponData then
        deathReason = weaponData[1] or locale("deathlog_was_killed")
        deathReasonShort = weaponData[2] or locale("deathlog_killed")

        if weaponKey then
            local weaponNameKey = weaponKey:gsub("WEAPON_", ""):lower()
            local localizedName = locale(weaponNameKey)
            if localizedName and localizedName ~= weaponNameKey then
                weaponName = localizedName
            else
                weaponName = weaponNameKey:gsub("^%l", string.upper)
                if weaponNameKey == "knife" then
                    weaponName = locale("deathlog_knife")
                elseif weaponNameKey == "nightstick" then
                    weaponName = locale("deathlog_nightstick")
                elseif weaponNameKey == "pistol" then
                    weaponName = locale("deathlog_pistol")
                elseif weaponNameKey == "combatpistol" then
                    weaponName = locale("deathlog_combat_pistol")
                elseif weaponNameKey == "smg" then
                    weaponName = locale("deathlog_smg")
                elseif weaponNameKey == "assaultrifle" then
                    weaponName = locale("deathlog_assault_rifle")
                elseif weaponNameKey == "sniperrifle" then
                    weaponName = locale("deathlog_sniper_rifle")
                end
            end
        else
            if causeOfDeath == -842959696 then
                weaponName = locale("deathlog_fall_damage")
            else
                weaponName = deathReason:gsub("been ", ""):gsub("been_", "")
            end
        end
    else
        if causeOfDeath == -842959696 then
            weaponName = locale("deathlog_fall_damage")
            deathReasonShort = locale("deathlog_fell")
            deathReason = locale("deathlog_fell_to_death")
        elseif causeOfDeath == -100946242 or causeOfDeath == 148160082 then
            weaponName = locale("deathlog_animal")
            deathReasonShort = locale("deathlog_mauled")
            deathReason = locale("deathlog_mauled_by_animal")
        else
            local weaponGroup = GetWeapontypeGroup(causeOfDeath)
            local groupName = Weapon_Groups[weaponGroup] or locale("deathlog_unknown")

            local reasonMap = {
                ['Melee'] = locale("stabbed"),
                ['Pistol'] = locale("shot"),
                ['Assault Rifle'] = locale("shot"),
                ['Shotgun'] = locale("shot"),
                ['LMG'] = locale("shot"),
                ['SMG'] = locale("shot"),
                ['Sniper'] = locale("shot"),
                ['Heavy'] = locale("deathlog_exploded"),
                ['Stunned'] = locale("deathlog_stunned"),
                ['Throwable'] = locale("deathlog_exploded"),
            }

            local groupNameMap = {
                ['Melee'] = locale("deathlog_melee"),
                ['Pistol'] = locale("deathlog_pistol"),
                ['Assault Rifle'] = locale("deathlog_assault_rifle"),
                ['Shotgun'] = locale("deathlog_shotgun"),
                ['LMG'] = locale("deathlog_lmg"),
                ['SMG'] = locale("deathlog_smg"),
                ['Sniper'] = locale("deathlog_sniper_rifle"),
                ['Heavy'] = locale("deathlog_heavy"),
                ['Stunned'] = locale("deathlog_stunned"),
                ['Throwable'] = locale("deathlog_throwable"),
            }
            weaponName = groupNameMap[groupName] or groupName
            deathReasonShort = reasonMap[groupName] or locale("deathlog_killed")
            deathReason = locale("deathlog_was_killed")
        end
    end

    if isVehicleKill then
        deathReason = locale("deathlog_flattened")
        deathReasonShort = locale("deathlog_run_over")
        weaponName = vehicleName or locale("deathlog_vehicle")
    end

    local isSuicide = false
    local currentServerId = cache.serverId or GetPlayerServerId(PlayerId())

    local isFallDamage = causeOfDeath == -842959696
    local isAnimal = causeOfDeath == -100946242 or causeOfDeath == 148160082

    if not isFallDamage and not isAnimal then
        if killerServerId and killerServerId == currentServerId then
            isSuicide = true
        elseif not killerServerId and sourceOfDeath == 0 then
            isSuicide = true
        end
    end

    if isSuicide then
        deathReason = locale("deathlog_suicide")
        deathReasonShort = locale("deathlog_suicide_reason")
        if not weaponData or weaponName == locale("deathlog_unknown") or weaponName == locale("deathlog_melee") or weaponName == locale("deathlog_pistol") or weaponName == locale("deathlog_knife") then
            weaponName = locale("deathlog_self_inflicted")
        end
        killerServerId = nil
    end

    local victimName = GetPlayerName(PlayerId())
    local message

    if killerServerId and killerServerId > 0 and not isSuicide then
        local killerName = GetPlayerName(GetPlayerFromServerId(killerServerId)) or locale("deathlog_unknown")
        message = string.format('**%s** %s by **%s** with a %s',
            victimName,
            deathReason,
            killerName,
            weaponName
        )
    else
        message = string.format('**%s** %s (%s)',
            victimName,
            deathReason,
            weaponName
        )
    end

    local damagedBodyPart = nil
    local found, lastDamagedBone = GetPedLastDamageBone(playerPed)
    if found and lastDamagedBone then
        local bodyPart = bodyParts[tostring(lastDamagedBone)]
        if bodyPart then
            damagedBodyPart = bodyPart.label
        end
    end

    TriggerServerEvent('ars_ambulancejob:deathlog:OnPlayerKilled', {
        message = message,
        weapon = weaponName,
        street = streetName,
        coords = coords,
        killer = isSuicide and nil or killerServerId,
        deathReason = deathReasonShort,
        bodyPart = damagedBodyPart
    })

    if Config.Debug then
        print('^5Deathlog^7: Death processed - Weapon: ' .. weaponName .. ', Reason: ' .. deathReasonShort)
    end
end

RegisterNetEvent('ars_ambulancejob:playerDied', function()
    Wait(500)
    processPlayerDeath()
end)
